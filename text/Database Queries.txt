CREATE DATABASE car_way;

CREATE TABLE office(
    office_id INT PRIMARY KEY AUTO_INCREMENT,
    office_name VARCHAR(255) NOT NULL,
    address TEXT NOT NULL
);

CREATE TABLE car(
    car_id INT PRIMARY KEY AUTO_INCREMENT,
    plate_id VARCHAR(255) NOT NULL UNIQUE,
    brand VARCHAR(255) NOT NULL,
    model VARCHAR(255) NOT NULL,
    type VARCHAR(255) NOT NULL,
    manufacture VARCHAR(255) NOT NULL,
    year INT NOT NULL,
    color VARCHAR(255) NOT NULL,
    office_id INT NOT NULL,
    price decimal NOT NULL,
    status ENUM ('active', 'out_of_service', 'rented') DEFAULT 'active',
    FOREIGN KEY (office_id) REFERENCES office(office_id)
);

CREATE TABLE customer(
    customer_id INT PRIMARY KEY AUTO_INCREMENT,
    first_name VARCHAR(255) NOT NULL,
    last_name VARCHAR(255) NOT NULL,
    Email VARCHAR(255) NOT NULL,
    phone VARCHAR(255) NOT NULL,
    password VARCHAR(255) NOT NULL,
    address TEXT
);

CREATE TABLE car_reservation(
    reservation_id INT PRIMARY KEY AUTO_INCREMENT,
    car_id INT NOT NULL,
    customer_id INT NOT NULL,
    reserve_date DATE NOT NULL, 
    pick_up_date DATE NOT NULL,
    return_date DATE NOT NULL,
    FOREIGN KEY (car_id) REFERENCES car(car_id),
    FOREIGN KEY (customer_id) REFERENCES customer(customer_id)
);

CREATE TABLE payment(
    payment_id INT PRIMARY KEY AUTO_INCREMENT,
    reservation_id INT NOT NULL,
    cash DECIMAL(8,2) NOT NULL,
    FOREIGN KEY (reservation_id) REFERENCES car_reservation(reservation_id)
);

CREATE TABLE office_accounts(
    office_id INT,
    Email VARCHAR(255) NOT NULL,
    password VARCHAR(255) NOT NULL,
    FOREIGN KEY(office_id) REFERENCES office(office_id)
);

-- office:
INSERT INTO office VALUES ('1','Car Way_newYork','new york');
INSERT INTO office VALUES ('2','Car Way_Egypt','Egypt');
INSERT INTO office VALUES ('3','Car Way_London','London');

-- Admin Accounts:
INSERT INTO office_accounts VALUES ('1','admin1@Carway.com','admin1');
INSERT INTO office_accounts VALUES ('2','admin2@Carway.com','admin2');
INSERT INTO office_accounts VALUES ('3','admin3@Carway.com','admin3');

=======================================================================================================================

# to know constraint_name for FOREIGN KEY in car_reservation table
SELECT constraint_name
FROM information_schema.key_column_usage
WHERE table_name = 'car_reservation' AND referenced_table_name = 'car';

ALTER TABLE car_reservation
DROP CONSTRAINT car_reservation_ibfk_1;


ALTER TABLE car_reservation
ADD CONSTRAINT delete_car FOREIGN KEY (car_id) 
REFERENCES car(car_id)
ON DELETE NO ACTION 
ON UPDATE CASCADE;

################################################################################
START TRIGGER
################################################################################
DELIMITER $$
CREATE TRIGGER before_car_delete
BEFORE DELETE ON car
FOR EACH ROW
BEGIN
    UPDATE car_reservation 
    SET car_id = 0
    WHERE car_id = OLD.car_id;
END$$
DELIMITER ;
